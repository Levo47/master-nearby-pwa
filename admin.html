<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–ê–¥–º–∏–Ω–∫–∞ ‚Äî –ú–∞—Å—Ç–µ—Ä —Ä—è–¥–æ–º</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="wrap">
    <h1>–ê–¥–º–∏–Ω–∫–∞</h1>
    <p class="muted">–î–æ–±–∞–≤–ª–µ–Ω–∏–µ, –ø—Ä–æ—Å–º–æ—Ç—Ä –∏ —É–¥–∞–ª–µ–Ω–∏–µ –º–∞—Å—Ç–µ—Ä–æ–≤ (SQLite).</p>

    <div class="card">
      <div class="row">
        <label class="field"><span>Admin token</span><input id="token" placeholder="ADMIN_TOKEN"/></label>
      </div>

      <h2>–î–æ–±–∞–≤–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞</h2>

      <div class="row">
        <label class="field"><span>–ò–º—è</span><input id="name" /></label>
        <label class="field"><span>–¢–µ–ª–µ—Ñ–æ–Ω</span><input id="phone" /></label>
      </div>

      <div class="row">
        <label class="field">
          <span>–£—Å–ª—É–≥–∞</span>
          <select id="service">
            <option value="plumber">–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫</option>
            <option value="electrician">–≠–ª–µ–∫—Ç—Ä–∏–∫</option>
            <option value="furniture">–°–±–æ—Ä–∫–∞ –º–µ–±–µ–ª–∏</option>
            <option value="handyman">–ú–∞—Å—Ç–µ—Ä –Ω–∞ —á–∞—Å</option>
          </select>
        </label>

        <label class="field"><span>–¶–µ–Ω–∞ –æ—Ç</span><input id="priceFrom" type="number" value="50"/></label>
      </div>

      <div class="row">
        <label class="field"><span>Rating (0‚Äì5)</span><input id="rating" type="number" step="0.1" value="4.6"/></label>
        <label class="field"><span>–ó–∞–∫–∞–∑–æ–≤</span><input id="jobs" type="number" value="0"/></label>
      </div>

      <div class="row">
        <label class="field"><span>–®–∏—Ä–æ—Ç–∞ (lat)</span><input id="lat" type="number" step="0.0001" placeholder="52.52"/></label>
        <label class="field"><span>–î–æ–ª–≥–æ—Ç–∞ (lng)</span><input id="lng" type="number" step="0.0001" placeholder="13.405"/></label>
      </div>

      <label class="field">
        <span>–û–ø–∏—Å–∞–Ω–∏–µ</span>
        <input id="tagline" placeholder="–ù–∞–ø—Ä. –ü—Ä–∏–µ–∑–∂–∞—é –±—ã—Å—Ç—Ä–æ" />
      </label>

      <label class="field" style="margin-top:10px;">
        <span><input id="isVerified" type="checkbox"/> –ü—Ä–æ–≤–µ—Ä–µ–Ω</span>
      </label>

      <div class="row">
        <button id="fillGeo">üìç –í—Å—Ç–∞–≤–∏—Ç—å –º–æ–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
        <button id="save" class="primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
        <button id="refresh">–û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
      </div>

      <pre id="status" class="status"></pre>
      <p class="muted">–û—Ç–∫—Ä—ã—Ç—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ: <a class="action" href="/">/</a></p>
    </div>

    <div class="card">
      <h2>–ú–∞—Å—Ç–µ—Ä–∞ (–¥–æ 200)</h2>
      <div id="list" class="list"></div>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const statusEl = $("status");
const listEl = $("list");

function token() { return $("token").value.trim(); }
function setStatus(msg){ statusEl.textContent = msg || ""; }
function esc(s){ return String(s).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c])); }

$("fillGeo").addEventListener("click", () => {
  if (!navigator.geolocation) return setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
  setStatus("–û–ø—Ä–µ–¥–µ–ª—è—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã‚Ä¶");
  navigator.geolocation.getCurrentPosition(
    (p) => { $("lat").value = p.coords.latitude; $("lng").value = p.coords.longitude; setStatus("–ì–æ—Ç–æ–≤–æ ‚úÖ"); },
    () => setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.")
  );
});

$("save").addEventListener("click", async () => {
  try {
    const payload = {
      name: $("name").value.trim(),
      phone: $("phone").value.trim(),
      service: $("service").value,
      priceFrom: Number($("priceFrom").value || 0),
      rating: Number($("rating").value || 4.5),
      jobs: Number($("jobs").value || 0),
      tagline: $("tagline").value.trim(),
      lat: Number($("lat").value),
      lng: Number($("lng").value),
      isVerified: $("isVerified").checked
    };

    setStatus("–°–æ—Ö—Ä–∞–Ω—è—é‚Ä¶");
    const res = await fetch("/api/masters", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-Admin-Token": token() },
      body: JSON.stringify(payload)
    });
    const data = await res.json().catch(() => ({}));
    if (!res.ok) throw new Error(JSON.stringify(data));
    setStatus("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚úÖ id=" + data.id);
    await refreshList();
  } catch (e) {
    setStatus("–û—à–∏–±–∫–∞: " + e.message);
  }
});

$("refresh").addEventListener("click", refreshList);

async function refreshList(){
  listEl.innerHTML = "";
  setStatus("–ó–∞–≥—Ä—É–∂–∞—é —Å–ø–∏—Å–æ–∫‚Ä¶");
  const res = await fetch("/api/admin/masters", { headers: { "X-Admin-Token": token() }});
  const data = await res.json().catch(() => ({}));
  if (!res.ok) { setStatus("–û—à–∏–±–∫–∞ —Å–ø–∏—Å–∫–∞: " + JSON.stringify(data)); return; }
  setStatus("–û–∫ ‚úÖ");

  (data.items || []).forEach(m => {
    const div = document.createElement("div");
    div.className = "item";
    div.innerHTML = `
      <div class="top">
        <strong>#${m.id} ${esc(m.name)}</strong>
        <span class="badge">${m.service} ¬∑ ${m.is_verified ? "‚úÖ verified" : "‚Äî"}</span>
      </div>
      <div class="muted">${esc(m.tagline || "")}</div>
      <div class="muted">‚≠ê ${Number(m.rating).toFixed(1)} ¬∑ ${m.jobs} –∑–∞–∫–∞–∑–æ–≤ ¬∑ –æ—Ç ${m.price_from} ¬∑ ${m.phone}</div>
      <div class="muted">(${m.lat}, ${m.lng})</div>
      <div class="actions">
        <a class="action" href="tel:${esc(m.phone)}">–ü–æ–∑–≤–æ–Ω–∏—Ç—å</a>
        <a class="action" data-del="${m.id}" href="#">–£–¥–∞–ª–∏—Ç—å</a>
      </div>
    `;
    div.querySelector('[data-del]')?.addEventListener("click", async (e) => {
      e.preventDefault();
      if (!confirm("–£–¥–∞–ª–∏—Ç—å –º–∞—Å—Ç–µ—Ä–∞ #" + m.id + "?")) return;
      const delRes = await fetch("/api/admin/masters/" + m.id, {
        method: "DELETE",
        headers: { "X-Admin-Token": token() }
      });
      const delData = await delRes.json().catch(() => ({}));
      if (!delRes.ok) { setStatus("–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è: " + JSON.stringify(delData)); return; }
      setStatus("–£–¥–∞–ª–µ–Ω–æ ‚úÖ");
      await refreshList();
    });
    listEl.appendChild(div);
  });
}

refreshList();
</script>
</body>
</html>

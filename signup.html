<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>–°—Ç–∞—Ç—å –º–∞—Å—Ç–µ—Ä–æ–º ‚Äî –ú–∞—Å—Ç–µ—Ä —Ä—è–¥–æ–º</title>
  <link rel="stylesheet" href="styles.css"/>
</head>
<body>
  <div class="wrap">
    <h1>–°—Ç–∞—Ç—å –º–∞—Å—Ç–µ—Ä–æ–º</h1>
    <p class="muted">–ó–∞–ø–æ–ª–Ω–∏ –¥–∞–Ω–Ω—ã–µ –∏ –ø—Ä–æ–π–¥–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –ª–∏—á–Ω–æ—Å—Ç–∏ (Sumsub), —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—É—Å ‚Äú–ü—Ä–æ–≤–µ—Ä–µ–Ω‚Äù.</p>

    <div class="card">
      <label class="field"><span>–ò–º—è</span><input id="name"/></label>
      <label class="field"><span>–¢–µ–ª–µ—Ñ–æ–Ω</span><input id="phone"/></label>
      <label class="field"><span>Email (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)</span><input id="email"/></label>

      <label class="field">
        <span>–£—Å–ª—É–≥–∞</span>
        <select id="service">
          <option value="plumber">–°–∞–Ω—Ç–µ—Ö–Ω–∏–∫</option>
          <option value="electrician">–≠–ª–µ–∫—Ç—Ä–∏–∫</option>
          <option value="furniture">–°–±–æ—Ä–∫–∞ –º–µ–±–µ–ª–∏</option>
          <option value="handyman">–ú–∞—Å—Ç–µ—Ä –Ω–∞ —á–∞—Å</option>
        </select>
      </label>

      <div class="row">
        <button id="geo">üìç –í—Å—Ç–∞–≤–∏—Ç—å –º–æ–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã</button>
        <button id="go" class="primary">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å ‚Üí –ü—Ä–æ–≤–µ—Ä–∫–∞</button>
      </div>

      <pre id="status" class="status"></pre>
    </div>
  </div>

<script>
const $ = (id) => document.getElementById(id);
const statusEl = $("status");
let coords = null;

function setStatus(t){ statusEl.textContent = t || ""; }

$("geo").addEventListener("click", () => {
  if (!navigator.geolocation) return setStatus("–ì–µ–æ–ª–æ–∫–∞—Ü–∏—è –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∞.");
  setStatus("–û–ø—Ä–µ–¥–µ–ª—è—é –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã‚Ä¶");
  navigator.geolocation.getCurrentPosition(
    (p) => { coords = {lat: p.coords.latitude, lng: p.coords.longitude}; setStatus("–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã –ø–æ–ª—É—á–µ–Ω—ã ‚úÖ"); },
    () => setStatus("–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –≥–µ–æ–ª–æ–∫–∞—Ü–∏—é.")
  );
});

$("go").addEventListener("click", async () => {
  try{
    if(!coords) throw new Error("–ù–∞–∂–º–∏ ‚Äú–í—Å—Ç–∞–≤–∏—Ç—å –º–æ–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã‚Äù");
    const payload = {
      name: $("name").value.trim(),
      phone: $("phone").value.trim(),
      email: $("email").value.trim() || null,
      service: $("service").value,
      lat: coords.lat,
      lng: coords.lng
    };
    setStatus("–°–æ–∑–¥–∞—é –ø—Ä–æ—Ñ–∏–ª—å‚Ä¶");
    const res = await fetch("/api/masters/signup", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify(payload)
    });
    const data = await res.json();
    if(!res.ok) throw new Error(JSON.stringify(data));

    localStorage.setItem("masterId", data.masterId);
    localStorage.setItem("authToken", data.authToken);

    location.href = "/kyc.html";
  } catch(e){
    setStatus("–û—à–∏–±–∫–∞: " + e.message);
  }
});
</script>
</body>
</html>
